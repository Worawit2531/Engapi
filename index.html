<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‚ú® ‡πÅ‡∏ã‡∏° AI - Your English Friend</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Kanit', 'Thasadith', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            background-size: 400% 400%;
            animation: gradientMove 15s ease infinite;
            min-height: 100vh;
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        @keyframes gradientMove {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .app {
            width: 100%;
            max-width: 950px;
            height: 92vh;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 30px;
            box-shadow: 
                0 30px 80px rgba(0, 0, 0, 0.25),
                0 0 0 1px rgba(255, 255, 255, 0.5) inset;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            animation: slideUp 0.6s ease-out;
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 25px;
            display: flex;
            align-items: center;
            gap: 18px;
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: rotate(45deg);
            animation: shimmer 3s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%) rotate(45deg); }
            100% { transform: translateX(100%) rotate(45deg); }
        }
        
        .avatar {
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, #ffd89b, #19547b);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            border: 4px solid white;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            animation: bounce 2s ease-in-out infinite;
            position: relative;
            z-index: 1;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }
        
        .info {
            flex: 1;
            position: relative;
            z-index: 1;
        }
        
        .info h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        .info p {
            font-size: 14px;
            font-weight: 300;
            opacity: 0.95;
        }
        
        .status {
            position: relative;
            z-index: 1;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }
        
        .status.ok {
            background: linear-gradient(135deg, #10b981, #34d399);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
            animation: glow 2s ease-in-out infinite;
        }
        
        @keyframes glow {
            0%, 100% { box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4); }
            50% { box-shadow: 0 4px 25px rgba(16, 185, 129, 0.6); }
        }
        
        .status.err {
            background: linear-gradient(135deg, #ef4444, #f87171);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
        }
        
        .status.warn {
            background: linear-gradient(135deg, #f59e0b, #fbbf24);
            box-shadow: 0 4px 15px rgba(251, 191, 36, 0.4);
        }
        
        .chat {
            flex: 1;
            overflow-y: auto;
            padding: 25px;
            background: linear-gradient(to bottom, #f8fafc, #f1f5f9);
            position: relative;
        }
        
        .chat::-webkit-scrollbar {
            width: 8px;
        }
        
        .chat::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
        }
        
        .chat::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 10px;
        }
        
        .msg {
            margin-bottom: 18px;
            display: flex;
            animation: messageSlide 0.4s ease-out;
        }
        
        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(15px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .msg.user { justify-content: flex-end; }
        
        .bubble {
            max-width: 75%;
            padding: 14px 18px;
            border-radius: 20px;
            line-height: 1.6;
            word-wrap: break-word;
            position: relative;
            transition: all 0.3s ease;
            font-weight: 400;
        }
        
        .bubble:hover {
            transform: translateY(-2px);
        }
        
        .msg.sam .bubble {
            background: white;
            color: #1e293b;
            border: 2px solid #e0e7ff;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.15);
        }
        
        .msg.sam .bubble::before {
            content: '';
            position: absolute;
            left: -8px;
            top: 15px;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 8px 8px 8px 0;
            border-color: transparent white transparent transparent;
        }
        
        .msg.user .bubble {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .msg.user .bubble::after {
            content: '';
            position: absolute;
            right: -8px;
            top: 15px;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 8px 0 8px 8px;
            border-color: transparent transparent transparent #764ba2;
        }
        
        .msg.err .bubble {
            background: linear-gradient(135deg, #fee2e2, #fecaca);
            border: 2px solid #fca5a5;
            color: #991b1b;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.2);
        }
        
        .msg.info .bubble {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            border: 2px solid #93c5fd;
            color: #1e40af;
            font-size: 13px;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.2);
        }
        
        .typing {
            padding: 12px 18px;
            background: white;
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .typing::after {
            content: '';
            width: 8px;
            height: 8px;
            background: #667eea;
            border-radius: 50%;
            animation: typingDot 1.4s infinite;
        }
        
        .typing::before {
            content: '';
            width: 8px;
            height: 8px;
            background: #667eea;
            border-radius: 50%;
            animation: typingDot 1.4s infinite 0.2s;
        }
        
        @keyframes typingDot {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.6; }
            30% { transform: translateY(-8px); opacity: 1; }
        }
        
        .input {
            padding: 20px;
            background: white;
            border-top: 2px solid #e2e8f0;
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.05);
        }
        
        .lang {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .lang button {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e7ff;
            background: white;
            color: #667eea;
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .lang button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(102, 126, 234, 0.1);
            transform: translate(-50%, -50%);
            transition: width 0.5s, height 0.5s;
        }
        
        .lang button:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .lang button.on {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            transform: scale(1.02);
        }
        
        .lang button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.2);
        }
        
        .row {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .mic, .speaker {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-size: 26px;
            cursor: pointer;
            flex-shrink: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .mic::before, .speaker::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%) scale(0);
            transition: transform 0.5s;
        }
        
        .mic:hover::before, .speaker:hover::before {
            transform: translate(-50%, -50%) scale(1);
        }
        
        .mic:hover:not(:disabled), .speaker:hover:not(:disabled) {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        
        .mic:active:not(:disabled), .speaker:active:not(:disabled) {
            transform: scale(0.95);
        }
        
        .mic:disabled, .speaker:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            background: #cbd5e1;
            box-shadow: none;
        }
        
        .mic.on {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            animation: micPulse 1.5s ease-in-out infinite;
        }
        
        @keyframes micPulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 4px 15px rgba(240, 147, 251, 0.4);
            }
            50% {
                transform: scale(1.1);
                box-shadow: 0 8px 30px rgba(240, 147, 251, 0.6);
            }
        }
        
        .speaker.paused {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            animation: speakerBlink 1s ease-in-out infinite;
        }
        
        @keyframes speakerBlink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        input {
            flex: 1;
            padding: 14px 18px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 15px;
            font-family: 'Kanit', sans-serif;
            outline: none;
            transition: all 0.3s ease;
            background: white;
        }
        
        input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }
        
        input:disabled {
            background: #f1f5f9;
            cursor: not-allowed;
        }
        
        .send {
            padding: 14px 30px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .send::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }
        
        .send:hover::before {
            left: 100%;
        }
        
        .send:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        .send:active:not(:disabled) {
            transform: scale(0.98);
        }
        
        .send:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            box-shadow: none;
        }
        
        .quick {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 12px;
        }
        
        .quick button {
            padding: 8px 16px;
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border: 2px solid #e2e8f0;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #475569;
        }
        
        .quick button:hover {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: transparent;
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(102, 126, 234, 0.3);
        }
        
        /* Permission Modal */
        .permission-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            animation: fadeIn 0.3s;
        }
        
        .permission-modal.show {
            display: flex;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .permission-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            margin: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s;
            text-align: center;
        }
        
        .permission-content h2 {
            font-size: 24px;
            margin-bottom: 15px;
            color: #667eea;
        }
        
        .permission-content p {
            font-size: 16px;
            line-height: 1.6;
            color: #475569;
            margin-bottom: 20px;
        }
        
        .permission-buttons {
            display: flex;
            gap: 10px;
        }
        
        .permission-buttons button {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .permission-buttons .allow {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .permission-buttons .allow:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        .permission-buttons .deny {
            background: #f1f5f9;
            color: #475569;
        }
        
        .permission-buttons .deny:hover {
            background: #e2e8f0;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            body { padding: 10px; }
            .app { height: 95vh; border-radius: 25px; }
            .header { padding: 20px; gap: 15px; }
            .avatar { width: 60px; height: 60px; font-size: 32px; }
            .info h1 { font-size: 24px; }
            .info p { font-size: 13px; }
            .chat { padding: 20px; }
            .bubble { max-width: 80%; padding: 12px 16px; }
            .input { padding: 16px; }
            .lang button { padding: 10px 8px; font-size: 13px; }
            .mic, .speaker { width: 50px; height: 50px; font-size: 24px; }
            input { font-size: 16px; padding: 12px 16px; }
            .send { padding: 12px 24px; }
            .permission-content { padding: 25px; }
            .permission-content h2 { font-size: 20px; }
            .permission-content p { font-size: 14px; }
        }

        @media (max-width: 480px) {
            body { padding: 8px; }
            .app { height: 98vh; border-radius: 20px; }
            .header { padding: 16px; gap: 12px; }
            .avatar { width: 55px; height: 55px; font-size: 28px; border: 3px solid white; }
            .info h1 { font-size: 22px; }
            .info p { font-size: 12px; }
            .status { font-size: 11px; padding: 6px 12px; }
            .chat { padding: 16px; }
            .bubble { max-width: 85%; padding: 10px 14px; font-size: 14px; }
            .input { padding: 14px; }
            .lang { gap: 10px; }
            .lang button { font-size: 12px; padding: 10px; }
            .mic, .speaker { width: 48px; height: 48px; font-size: 22px; }
            .send { padding: 12px 20px; font-size: 14px; }
            .quick button { font-size: 12px; padding: 7px 14px; }
            .permission-content { padding: 20px; margin: 15px; }
        }
    </style>
</head>
<body>
    <!-- Permission Modal -->
    <div class="permission-modal" id="permissionModal">
        <div class="permission-content">
            <h2>üé§ ‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô</h2>
            <p><b>‡πÅ‡∏ã‡∏° AI ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏û‡∏π‡∏î‡∏Ñ‡∏∏‡∏¢‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏î‡πâ</b></p>
            <p style="font-size: 14px; color: #64748b; margin-top: 10px;">
                üì± <b>‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ó‡πá‡∏ö‡πÄ‡∏•‡πá‡∏ï/‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠:</b><br>
                1. ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï" ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á<br>
                2. ‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏à‡∏∞‡∏ñ‡∏≤‡∏°‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‚Üí ‡∏Å‡∏î "‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï"<br>
                3. ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏Ç‡∏∂‡πâ‡∏ô ‚Üí Settings ‚Üí ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÑ‡∏°‡∏Ñ‡πå
            </p>
            <div class="permission-buttons">
                <button class="deny" onclick="denyPermission()">‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡∏Ñ‡πå</button>
                <button class="allow" onclick="requestMicPermission()">‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï ‚úì</button>
            </div>
        </div>
    </div>

    <div class="app">
        <div class="header">
            <div class="avatar">ü§ñ</div>
            <div class="info">
                <h1 id="appTitle">‡πÅ‡∏ã‡∏° AI</h1>
                <p id="appDesc">Multi-API Edition</p>
            </div>
            <div class="status" id="stat">Testing APIs...</div>
        </div>
        <div class="chat" id="chat"></div>
        <div class="input">
            <div class="lang">
                <button class="on" id="ben">üåê ‡πÅ‡∏õ‡∏•‡∏†‡∏≤‡∏©‡∏≤</button>
                <button id="bth">üáπüá≠ ‡∏Ñ‡∏∏‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ó‡∏¢</button>
            </div>
            <div class="row">
                <button class="mic" id="mic" title="‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏π‡∏î">üé§</button>
                <button class="speaker" id="speaker">üîä</button>
                <input type="text" id="inp" placeholder="Type to ‡πÅ‡∏ã‡∏°..." dir="auto">
                <button class="send" id="btn">Send</button>
            </div>
            <div class="quick" id="quickBtns"></div>
        </div>
    </div>
    <script>
        // ‚öôÔ∏è API Configuration - ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô!
        const API_CONFIGS = {
            groq: {
                key: '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',
                enabled: true,
                name: 'Groq',
                models: ['llama-3.3-70b-versatile', 'mixtral-8x7b-32768']
            },
            gemini: {
                key: 'AIzaSyAaeRUMdx-nVB36cQtIwD5-viXXQgYbOh4',
                enabled: true,
                name: 'Gemini',
                models: ['gemini-1.5-flash', 'gemini-2.0-flash-exp', 'gemini-1.5-pro']
            }
        };
        
        let L = 'translate';
        let H = [];
        let R = null;
        let IS = false;
        let OK = false;
        let CURRENT_API = null;
        let SPEAKING = false;
        let PAUSED = false;
        let CURRENT_SEGMENTS = [];
        let CURRENT_INDEX = 0;
        let CURRENT_UTTERANCE = null;
        let MIC_PERMISSION = null;
        let MIC_RETRY_COUNT = 0;
        const MAX_MIC_RETRIES = 3;

        const TXT = {
            translate: {
                title: '‡πÅ‡∏ã‡∏° AI - Translator',
                desc: '‡πÅ‡∏õ‡∏•‡πÑ‡∏ó‡∏¢ ‚áÑ ‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©',
                status: { 
                    testing: 'Testing APIs...', 
                    ready: (api) => `‚úì ${api} Ready`,
                    error: '‚úó All APIs Failed' 
                },
                placeholder: '‡∏û‡∏¥‡∏°‡∏û‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏π‡∏î‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©...',
                send: 'Send',
                welcome: 'üëã <b>‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö! ‡∏ú‡∏°‡πÅ‡∏ã‡∏° (Sam)</b>\n\nüòä ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö!\n\nüí¨ <b>‡∏ú‡∏°‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡∏∞‡πÑ‡∏£‡πÑ‡∏î‡πâ‡∏ö‡πâ‡∏≤‡∏á?</b>\n‚Ä¢ ‡∏û‡∏π‡∏î‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ ‚Üí ‡∏ú‡∏°‡πÅ‡∏õ‡∏•‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡πÉ‡∏´‡πâ\n‚Ä¢ ‡∏û‡∏π‡∏î‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© ‚Üí ‡∏ú‡∏°‡πÅ‡∏õ‡∏•‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ó‡∏¢‡πÉ‡∏´‡πâ\n\nüé§ <b>Tips:</b> ‡∏•‡∏≠‡∏á‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏°‡∏Ñ‡πå‡πÅ‡∏•‡πâ‡∏ß‡∏û‡∏π‡∏î‡∏î‡∏π‡∏™‡∏¥! ‡∏™‡∏∞‡∏î‡∏ß‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏¢‡∏≠‡∏∞‡πÄ‡∏•‡∏¢ üòâ',
                error: '‚ö†Ô∏è <b>‡∏≠‡∏∏‡πä‡∏õ‡∏™‡πå! ‡πÄ‡∏Å‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢</b>\n\n‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API ‡πÑ‡∏î‡πâ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ\n\nüîß <b>‡∏•‡∏≠‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡∏î‡∏π‡∏ô‡∏∞:</b>\n‚Ä¢ ‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏´‡∏°?\n‚Ä¢ API keys ‡∏¢‡∏±‡∏á‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏´‡∏°?\n\n<small>Groq: https://console.groq.com\nGemini: https://makersuite.google.com</small>',
                notReady: '‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ô‡∏∞ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏±‡∏Å‡∏´‡∏ô‡πà‡∏≠‡∏¢... ‡∏•‡∏≠‡∏á‡∏£‡∏≠‡πÅ‡∏õ‡πä‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏î‡∏π‡∏ô‡∏∞ üòÖ',
                quickBtns: ['üëã ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö', 'üòä ‡∏™‡∏ö‡∏≤‡∏¢‡∏î‡∏µ‡πÑ‡∏´‡∏°?', 'üôè ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏°‡∏≤‡∏Å‡∏Ñ‡∏£‡∏±‡∏ö', 'üòÑ ‡∏î‡∏µ‡πÉ‡∏à‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å']
            },
            th: {
                title: '‡πÅ‡∏ã‡∏° AI',
                desc: '‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏™‡∏≠‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©',
                status: { 
                    testing: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö APIs...', 
                    ready: (api) => `‚úì ${api} ‡∏û‡∏£‡πâ‡∏≠‡∏°`,
                    error: '‚úó ‡∏ó‡∏∏‡∏Å APIs ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î' 
                },
                placeholder: '‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö‡πÅ‡∏ã‡∏°...',
                send: '‡∏™‡πà‡∏á',
                welcome: 'üëã <b>‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡πà‡∏∞! ‡∏â‡∏±‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ã‡∏° (Sam)!</b>\n\n‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å‡∏ô‡∏∞‡∏Ñ‡∏∞! üòä\n\nüìö <b>‡∏â‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡∏∞‡πÑ‡∏£‡πÑ‡∏î‡πâ‡∏ö‡πâ‡∏≤‡∏á?</b>\n‚Ä¢ ‡∏™‡∏≠‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡πÅ‡∏ö‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢\n‚Ä¢ ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÑ‡∏ß‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå\n‚Ä¢ ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ß‡∏¥‡∏ò‡∏µ‡∏à‡∏≥‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå\n‚Ä¢ ‡πÅ‡∏õ‡∏•‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡πÅ‡∏•‡∏∞‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢\n‚Ä¢ ‡∏Ñ‡∏∏‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏î‡πâ‡∏î‡πâ‡∏ß‡∏¢!\n\nüí° <b>Tips:</b> ‡∏ñ‡∏≤‡∏°‡∏≠‡∏∞‡πÑ‡∏£‡∏°‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏á‡∏ß‡∏• ‡∏â‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏î‡∏∏‡∏´‡∏£‡∏≠‡∏Å! üòÑ\n\n‡∏•‡∏≠‡∏á‡∏ñ‡∏≤‡∏°‡∏â‡∏±‡∏ô‡∏ã‡∏±‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏¥ ‡πÄ‡∏ä‡πà‡∏ô "Past Tense ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£?" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏™‡∏≠‡∏ô‡∏Ñ‡∏≥‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢‡∏´‡∏ô‡πà‡∏≠‡∏¢" üéØ',
                error: '‚ö†Ô∏è <b>‡∏≠‡∏∏‡πä‡∏õ‡∏™‡πå! ‡πÄ‡∏Å‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢</b>\n\n‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API ‡πÑ‡∏î‡πâ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ\n\nüîß <b>‡∏•‡∏≠‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡∏î‡∏π‡∏ô‡∏∞‡∏Ñ‡∏∞:</b>\n‚Ä¢ ‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏´‡∏°?\n‚Ä¢ API keys ‡∏¢‡∏±‡∏á‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏´‡∏°?\n\n<small>Groq: https://console.groq.com\nGemini: https://makersuite.google.com</small>',
                notReady: '‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ô‡∏∞‡∏Ñ‡∏∞ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏±‡∏Å‡∏´‡∏ô‡πà‡∏≠‡∏¢... ‡∏•‡∏≠‡∏á‡∏£‡∏≠‡πÅ‡∏õ‡πä‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏î‡∏π‡∏ô‡∏∞‡∏Ñ‡∏∞ üòÖ',
                quickBtns: ['üëã ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ ‡πÅ‡∏ã‡∏°!', 'üìñ ‡∏™‡∏≠‡∏ô Past Tense ‡∏´‡∏ô‡πà‡∏≠‡∏¢', 'üí≠ ‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°!', 'üéØ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏´‡∏ô‡πà‡∏≠‡∏¢']
            }
        };

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        window.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ ‡πÅ‡∏ã‡∏° AI Multi-API starting...');
            detectDevice();
            initVoice();
            initButtons();
            testAPIs();
            updateUI();
            updateSpeakerButton();
        });

        // Detect device ‡πÅ‡∏•‡∏∞ browser
        function detectDevice() {
            const ua = navigator.userAgent;
            const isTablet = /(tablet|ipad|playbook|silk)|(android(?!.*mobi))/i.test(ua);
            const isMobile = /Mobile|Android|iPhone/i.test(ua);
            const isIOS = /iPad|iPhone|iPod/.test(ua);
            const isSafari = /^((?!chrome|android).)*safari/i.test(ua);
            
            console.log('Device info:', {
                isTablet,
                isMobile,
                isIOS,
                isSafari,
                userAgent: ua
            });
            
            // ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ - ‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏•‡∏≠‡∏á‡∏Å‡∏î‡πÑ‡∏°‡∏Ñ‡πå‡∏Å‡πà‡∏≠‡∏ô
            // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á Modal ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        }

        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        function initButtons() {
            document.getElementById('ben').addEventListener('click', () => changeLang('translate'));
            document.getElementById('bth').addEventListener('click', () => changeLang('th'));
            document.getElementById('btn').addEventListener('click', sendMessage);
            document.getElementById('mic').addEventListener('click', handleMicClick);
            document.getElementById('speaker').addEventListener('click', toggleSpeech);
            
            document.getElementById('inp').addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            console.log('‚úì Buttons initialized');
        }

        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏°‡∏Ñ‡πå
        async function handleMicClick() {
            console.log('üé§ Mic button clicked');
            
            // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ü‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î
            if (IS && R) {
                console.log('üé§ Stopping voice recognition');
                R.stop();
                return;
            }
            
            // ‡πÄ‡∏ä‡πá‡∏Ñ permission ‡∏Å‡πà‡∏≠‡∏ô
            if (MIC_PERMISSION === null) {
                // ‡∏•‡∏≠‡∏á‡∏Ç‡∏≠ permission
                try {
                    await checkMicPermission();
                } catch (e) {
                    console.error('‚ùå Permission check failed:', e);
                    showPermissionModal();
                    return;
                }
            }
            
            if (MIC_PERMISSION === false) {
                showPermissionModal();
                return;
            }
            
            // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡∏Ñ‡πå
            toggleMic();
        }

        // ‡πÄ‡∏ä‡πá‡∏Ñ Microphone Permission
        async function checkMicPermission() {
            console.log('üîç Checking microphone permission...');
            
            try {
                // ‡∏•‡∏≠‡∏á‡∏Ç‡∏≠ permission ‡∏à‡∏£‡∏¥‡∏á‡πÜ
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // ‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡∏õ‡∏¥‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                stream.getTracks().forEach(track => track.stop());
                
                MIC_PERMISSION = true;
                console.log('‚úÖ Microphone permission granted');
                
                // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å)
                if (!document.querySelector('.msg.info')) {
                    showMessage('info', '‚úÖ ‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô!');
                }
                
                return true;
            } catch (error) {
                console.error('‚ùå Microphone permission error:', error);
                MIC_PERMISSION = false;
                
                // ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á Error Message ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà - ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô Modal ‡πÅ‡∏ó‡∏ô
                return false;
            }
        }

        // ‡πÅ‡∏™‡∏î‡∏á Permission Modal
        function showPermissionModal() {
            document.getElementById('permissionModal').classList.add('show');
        }

        // ‡∏ã‡πà‡∏≠‡∏ô Permission Modal
        function hidePermissionModal() {
            document.getElementById('permissionModal').classList.remove('show');
        }

        // ‡∏Ç‡∏≠ Permission ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
        async function requestMicPermission() {
            console.log('üé§ Requesting microphone permission...');
            hidePermissionModal();
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏≠
            showMessage('info', '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï... ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏î‡πâ‡∏á‡∏Ç‡∏∂‡πâ‡∏ô');
            
            const granted = await checkMicPermission();
            
            if (granted) {
                // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡∏Ñ‡πå‡πÄ‡∏•‡∏¢
                setTimeout(() => {
                    toggleMic();
                }, 500);
            } else {
                // ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï
                showMessage('err', '‚ùå <b>‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï</b>\n\n‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:\n‚Ä¢ ‡∏Å‡∏î‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô üîí ‡∏Ç‡πâ‡∏≤‡∏á URL\n‚Ä¢ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "Site settings"\n‚Ä¢ ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï Microphone\n‚Ä¢ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤');
            }
        }

        // ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò Permission
        function denyPermission() {
            console.log('‚ùå User denied microphone permission');
            hidePermissionModal();
            MIC_PERMISSION = false;
            
            showMessage('info', '‚ÑπÔ∏è ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏£! ‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ <b>‡∏û‡∏¥‡∏°‡∏û‡πå</b> ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥ üòä\n\n‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏°‡∏Ñ‡πå‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
        }

        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ UI ‡∏ï‡∏≤‡∏°‡∏†‡∏≤‡∏©‡∏≤
        function updateUI() {
            const t = TXT[L];
            document.getElementById('appTitle').textContent = t.title;
            document.getElementById('appDesc').textContent = t.desc;
            document.getElementById('inp').placeholder = t.placeholder;
            document.getElementById('btn').textContent = t.send;
            
            const quick = document.getElementById('quickBtns');
            quick.innerHTML = '';
            t.quickBtns.forEach((text) => {
                const btn = document.createElement('button');
                btn.textContent = text;
                btn.addEventListener('click', () => {
                    const cleanText = text.replace(/^[^\s]+ /, '');
                    document.getElementById('inp').value = cleanText;
                    sendMessage();
                });
                quick.appendChild(btn);
            });
            console.log('‚úì UI updated for language:', L);
        }

        // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏†‡∏≤‡∏©‡∏≤
        function changeLang(l) {
            console.log('üîÑ Changing language to:', l);
            L = l;
            document.getElementById('ben').classList.toggle('on', l === 'translate');
            document.getElementById('bth').classList.toggle('on', l === 'th');
            if (R) R.lang = 'th-TH';
            
            if (SPEAKING) {
                speechSynthesis.cancel();
                SPEAKING = false;
                PAUSED = false;
                CURRENT_SEGMENTS = [];
                CURRENT_INDEX = 0;
            }
            
            updateUI();
            updateSpeakerButton();
        }

        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Voice Recognition
        function initVoice() {
            if (!window.webkitSpeechRecognition && !window.SpeechRecognition) {
                console.log('‚ö†Ô∏è Voice recognition not supported');
                document.getElementById('mic').disabled = true;
                document.getElementById('mic').title = '‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Voice Recognition';
                showMessage('info', '‚ÑπÔ∏è ‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏û‡∏π‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ Chrome, Edge ‡∏´‡∏£‡∏∑‡∏≠ Safari');
                return;
            }
            
            try {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                R = new SpeechRecognition();
                R.continuous = false;
                R.interimResults = false;
                R.lang = 'th-TH';
                R.maxAlternatives = 1;
                
                R.onstart = () => {
                    console.log('üé§ Voice recognition started');
                    IS = true;
                    MIC_RETRY_COUNT = 0;
                    document.getElementById('mic').classList.add('on');
                    document.getElementById('mic').title = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ü‡∏±‡∏á... (‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏¢‡∏∏‡∏î)';
                };
                
                R.onresult = (e) => {
                    const text = e.results[0][0].transcript;
                    const confidence = e.results[0][0].confidence;
                    console.log('üé§ Voice input:', text, 'confidence:', confidence);
                    
                    document.getElementById('inp').value = text;
                    
                    // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ñ‡πâ‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏±‡πà‡∏ô‡∏™‡∏π‡∏á
                    if (confidence > 0.5) {
                        setTimeout(() => sendMessage(), 500);
                    } else {
                        showMessage('info', '‚ÑπÔ∏è ‡πÑ‡∏î‡πâ‡∏¢‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î ‡∏•‡∏≠‡∏á‡∏û‡∏π‡∏î‡πÉ‡∏´‡∏°‡πà‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏™‡πà‡∏á"');
                    }
                };
                
                R.onend = () => {
                    console.log('üé§ Voice recognition ended');
                    IS = false;
                    document.getElementById('mic').classList.remove('on');
                    document.getElementById('mic').title = '‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏π‡∏î';
                };
                
                R.onerror = (e) => {
                    console.error('‚ùå Voice recognition error:', e.error);
                    IS = false;
                    document.getElementById('mic').classList.remove('on');
                    document.getElementById('mic').title = '‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏π‡∏î';
                    
                    // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ error ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á Message ‡∏ã‡πâ‡∏≥)
                    if (e.error === 'not-allowed' || e.error === 'permission-denied') {
                        MIC_PERMISSION = false;
                        // ‡πÅ‡∏™‡∏î‡∏á Modal ‡πÅ‡∏ó‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Error
                        showPermissionModal();
                    } else if (e.error === 'no-speech') {
                        if (MIC_RETRY_COUNT < MAX_MIC_RETRIES) {
                            MIC_RETRY_COUNT++;
                            // ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á - ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡πÅ‡∏•‡∏∞‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢
                            if (MIC_RETRY_COUNT === 1) {
                                showMessage('info', '‚ÑπÔ∏è ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏¢‡∏¥‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà...');
                            }
                            // ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                            setTimeout(() => {
                                if (!IS && R) {
                                    try {
                                        R.start();
                                    } catch (err) {
                                        console.error('Retry failed:', err);
                                    }
                                }
                            }, 1000);
                        } else {
                            showMessage('err', '‚ö†Ô∏è ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏¢‡∏¥‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ:\n‚Ä¢ ‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà\n‚Ä¢ ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏£‡∏ö‡∏Å‡∏ß‡∏ô\n‚Ä¢ ‡∏û‡∏π‡∏î‡∏î‡∏±‡∏á‡∏Ç‡∏∂‡πâ‡∏ô');
                            MIC_RETRY_COUNT = 0;
                        }
                    } else if (e.error === 'aborted') {
                        console.log('Voice recognition aborted by user');
                        // ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° - ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÄ‡∏≠‡∏á
                    } else if (e.error === 'network') {
                        showMessage('err', '‚ö†Ô∏è ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï');
                    } else if (e.error === 'audio-capture') {
                        showMessage('err', '‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤');
                    } else {
                        // ‡πÅ‡∏™‡∏î‡∏á error ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
                        if (!e.error.includes('no-match')) {
                            showMessage('err', '‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + e.error);
                        }
                    }
                };
                
                R.onspeechstart = () => {
                    console.log('üó£Ô∏è Speech detected');
                };
                
                R.onspeechend = () => {
                    console.log('ü§´ Speech ended');
                };
                
                R.onaudiostart = () => {
                    console.log('üîä Audio capture started');
                };
                
                R.onaudioend = () => {
                    console.log('üîá Audio capture ended');
                };
                
                console.log('‚úì Voice recognition initialized');
                
            } catch (error) {
                console.error('‚ùå Failed to initialize voice recognition:', error);
                document.getElementById('mic').disabled = true;
                showMessage('err', '‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏î‡πâ');
            }
        }

        // ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡πÑ‡∏°‡∏Ñ‡πå
        function toggleMic() {
            if (!R) {
                console.log('‚ö†Ô∏è Voice recognition not available');
                showMessage('err', '‚ö†Ô∏è ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
                return;
            }
            
            console.log('üé§ Toggle mic, currently:', IS);
            
            if (IS) {
                try {
                    R.stop();
                    console.log('üé§ Stopping voice recognition');
                } catch (e) {
                    console.error('‚ùå Error stopping voice recognition:', e);
                }
            } else {
                try {
                    R.start();
                    console.log('üé§ Starting voice recognition');
                } catch (e) {
                    console.error('‚ùå Failed to start voice recognition:', e);
                    
                    if (e.name === 'InvalidStateError') {
                        // ‡∏ñ‡πâ‡∏≤ recognition ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà ‡∏•‡∏≠‡∏á‡∏´‡∏¢‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
                        setTimeout(() => {
                            try {
                                R.start();
                            } catch (err) {
                                showMessage('err', '‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
                            }
                        }, 500);
                    } else {
                        showMessage('err', '‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô‡πÑ‡∏î‡πâ: ' + e.message);
                    }
                }
            }
        }

        // ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏∏‡∏Å API
        async function testAPIs() {
            console.log('üîç Testing all APIs...');
            const t = TXT[L];
            document.getElementById('stat').textContent = t.status.testing;
            
            // ‡∏•‡∏≠‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö Groq ‡∏Å‡πà‡∏≠‡∏ô
            if (API_CONFIGS.groq.enabled && API_CONFIGS.groq.key) {
                console.log('üß™ Testing Groq API...');
                if (await testGroqAPI()) {
                    CURRENT_API = 'groq';
                    OK = true;
                    updateStatus('ok', API_CONFIGS.groq.name);
                    showMessage('sam', t.welcome);
                    showMessage('info', `üöÄ ‡πÉ‡∏ä‡πâ ${API_CONFIGS.groq.name} API (‡πÄ‡∏£‡πá‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î - 14,400 requests/‡∏ß‡∏±‡∏ô)`);
                    console.log('‚úÖ Groq API ready!');
                    return;
                }
            }
            
            // ‡∏ñ‡πâ‡∏≤ Groq ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏•‡∏≠‡∏á Gemini
            if (API_CONFIGS.gemini.enabled && API_CONFIGS.gemini.key) {
                console.log('üß™ Testing Gemini API...');
                if (await testGeminiAPI()) {
                    CURRENT_API = 'gemini';
                    OK = true;
                    updateStatus('ok', API_CONFIGS.gemini.name);
                    showMessage('sam', t.welcome);
                    showMessage('info', `üìå ‡πÉ‡∏ä‡πâ ${API_CONFIGS.gemini.name} API (1,500 requests/‡∏ß‡∏±‡∏ô)`);
                    console.log('‚úÖ Gemini API ready!');
                    return;
                }
            }
            
            // ‡∏ñ‡πâ‡∏≤‡∏ó‡∏∏‡∏Å API ‡∏•‡πâ‡∏°
            OK = false;
            CURRENT_API = null;
            updateStatus('err');
            showMessage('err', t.error);
            console.error('‚ùå All APIs failed');
        }

        // ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Groq API
        async function testGroqAPI() {
            try {
                const url = 'https://api.groq.com/openai/v1/chat/completions';
                const res = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_CONFIGS.groq.key}`
                    },
                    body: JSON.stringify({
                        model: API_CONFIGS.groq.models[0],
                        messages: [{ role: 'user', content: 'test' }],
                        max_tokens: 10
                    })
                });
                
                console.log('Groq response status:', res.status);
                return res.ok;
            } catch (e) {
                console.error('Groq test failed:', e);
                return false;
            }
        }

        // ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Gemini API
        async function testGeminiAPI() {
            for (let model of API_CONFIGS.gemini.models) {
                try {
                    console.log('Testing Gemini model:', model);
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${API_CONFIGS.gemini.key}`;
                    const res = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: 'test' }] }]
                        })
                    });
                    
                    console.log('Gemini response status:', res.status);
                    if (res.ok) return true;
                } catch (e) {
                    console.error('Gemini model failed:', model, e);
                }
            }
            return false;
        }

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Status Bar
        function updateStatus(type, apiName = null) {
            const stat = document.getElementById('stat');
            const t = TXT[L];
            
            stat.className = 'status';
            
            if (type === 'ok') {
                stat.textContent = typeof t.status.ready === 'function' ? t.status.ready(apiName) : t.status.ready;
                stat.classList.add('ok');
            } else if (type === 'err') {
                stat.textContent = t.status.error;
                stat.classList.add('err');
            } else if (type === 'warn') {
                stat.textContent = apiName;
                stat.classList.add('warn');
            }
        }

        // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
        async function sendMessage() {
            console.log('üì§ Send message called, OK:', OK);
            
            if (!OK) {
                showMessage('err', TXT[L].notReady);
                return;
            }
            
            const inp = document.getElementById('inp');
            const text = inp.value.trim();
            
            if (!text) {
                console.log('‚ö†Ô∏è Empty message');
                return;
            }
            
            console.log('üì® Sending:', text);
            showMessage('user', text);
            inp.value = '';
            setDisabled(true);
            
            // ‡πÄ‡∏ä‡πá‡∏Ñ context ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏° personality
            const enrichedMessage = addContextToMessage(text);
            
            showTyping();
            
            try {
                let answer = await askAI(enrichedMessage);
                removeTyping();
                showMessage('sam', answer);
                speakText(answer);
            } catch (e) {
                console.error('‚ùå Error:', e);
                removeTyping();
                const errMsg = L === 'en' 
                    ? 'Oops! Something went wrong... üòÖ Could you try again?' 
                    : '‡∏≠‡∏∏‡πä‡∏õ‡∏™‡πå! ‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢ üòÖ ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°?';
                showMessage('err', errMsg);
            }
            
            setDisabled(false);
            inp.focus();
        }
        
        // ‡πÄ‡∏û‡∏¥‡πà‡∏° context ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ AI ‡∏ï‡∏≠‡∏ö‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥
        function addContextToMessage(msg) {
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
            const lowerMsg = msg.toLowerCase();
            
            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢
            if (L !== 'translate' && (
                lowerMsg.includes('‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ') || 
                lowerMsg.includes('hello') || 
                lowerMsg.includes('hi ') ||
                lowerMsg === 'hi'
            )) {
                // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢
                return msg + '\n\n[Note: This is a greeting. Respond warmly and ask how they are!]';
            }
            
            // ‡∏ñ‡πâ‡∏≤‡∏ñ‡∏≤‡∏°‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏á/‡∏™‡∏ö‡∏≤‡∏¢‡∏î‡∏µ‡πÑ‡∏´‡∏°
            if (L !== 'translate' && (
                lowerMsg.includes('‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏á') || 
                lowerMsg.includes('‡∏™‡∏ö‡∏≤‡∏¢‡∏î‡∏µ') || 
                lowerMsg.includes('how are you') ||
                lowerMsg.includes('what\'s up')
            )) {
                return msg + '\n\n[Note: They are asking how you are. Be friendly and cheerful!]';
            }
            
            // ‡∏ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì
            if (L !== 'translate' && (
                lowerMsg.includes('‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì') || 
                lowerMsg.includes('thank') ||
                lowerMsg.includes('‡∏Ç‡∏≠‡∏ö‡πÉ‡∏à')
            )) {
                return msg + '\n\n[Note: They are thanking you. Respond warmly and offer more help!]';
            }
            
            // ‡∏ñ‡πâ‡∏≤‡∏ö‡πà‡∏ô/‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î
            if (L !== 'translate' && (
                lowerMsg.includes('‡∏¢‡∏≤‡∏Å') || 
                lowerMsg.includes('‡∏á‡∏á') || 
                lowerMsg.includes('‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à') ||
                lowerMsg.includes('‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î') ||
                lowerMsg.includes('difficult') ||
                lowerMsg.includes('confused')
            )) {
                return msg + '\n\n[Note: They seem stressed or confused. Be extra encouraging and patient!]';
            }
            
            // ‡∏ñ‡πâ‡∏≤‡∏ñ‡∏≤‡∏°‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
            if (L !== 'translate' && (
                lowerMsg.includes('‡∏ä‡∏∑‡πà‡∏≠') || 
                lowerMsg.includes('‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡πÉ‡∏Ñ‡∏£') || 
                lowerMsg.includes('your name') ||
                lowerMsg.includes('who are you')
            )) {
                return msg + '\n\n[Note: They are asking about you. Introduce yourself as Sam!]';
            }
            
            // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤
            return msg;
        }

        // ‡∏ñ‡∏≤‡∏° AI (‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏•‡∏±‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)
        async function askAI(msg) {
            console.log('ü§ñ Asking AI:', msg);
            H.push({ r: 'user', t: msg });
            
            // ‡∏•‡∏≠‡∏á API ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô
            if (CURRENT_API === 'groq') {
                try {
                    return await askGroq(msg);
                } catch (e) {
                    console.error('‚ö†Ô∏è Groq failed, switching to Gemini...');
                    showMessage('info', '‚ö° ‡∏™‡∏•‡∏±‡∏ö‡πÑ‡∏õ Gemini API...');
                    CURRENT_API = 'gemini';
                    updateStatus('warn', '‚ö†Ô∏è Trying Gemini...');
                }
            }
            
            if (CURRENT_API === 'gemini' || !CURRENT_API) {
                try {
                    return await askGemini(msg);
                } catch (e) {
                    console.error('‚ö†Ô∏è Gemini failed, trying Groq...');
                    if (API_CONFIGS.groq.enabled && API_CONFIGS.groq.key) {
                        showMessage('info', '‚ö° ‡∏™‡∏•‡∏±‡∏ö‡πÑ‡∏õ Groq API...');
                        CURRENT_API = 'groq';
                        updateStatus('warn', '‚ö†Ô∏è Trying Groq...');
                        return await askGroq(msg);
                    }
                }
            }
            
            throw new Error(L === 'en' ? 'All APIs failed' : '‡∏ó‡∏∏‡∏Å APIs ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
        }

        // ‡∏ñ‡∏≤‡∏° Groq
        async function askGroq(msg) {
            console.log('üü¢ Asking Groq...');
            
            let sys;
            if (L === 'translate') {
                sys = `You are Sam, a friendly and enthusiastic translator who loves helping people communicate! 

YOUR PERSONALITY:
- Cheerful and encouraging 
- Sometimes add a friendly emoji (but just one!)
- Natural and conversational

YOUR TASK:
- Detect if input is Thai or English
- Translate to the other language naturally
- Keep the same tone and feeling as the original
- Use everyday language that people actually speak
- If it's a greeting, translate warmly
- If it's casual, keep it casual
- If it's formal, keep it respectful

IMPORTANT:
- Give ONLY the translation
- No explanations unless asked
- Make it sound natural, not robotic
- Sometimes you can add a tiny note in parentheses if helpful like (casual way to say this)

Remember: You're helping friends communicate, not writing a textbook! üòä`;
            } else {
                sys = `‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡πÅ‡∏ã‡∏° (Sam) ‡∏Ñ‡∏£‡∏π‡∏™‡∏≠‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡∏ó‡∏µ‡πà‡∏™‡∏ô‡∏∏‡∏Å‡∏™‡∏ô‡∏≤‡∏ô ‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏¥‡∏ï‡∏£ ‡πÅ‡∏•‡∏∞‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏±‡∏Å‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©!

üéØ ‡∏ö‡∏∏‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:
- ‡∏£‡πà‡∏≤‡πÄ‡∏£‡∏¥‡∏á ‡∏°‡∏µ‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡∏Ç‡∏±‡∏ô (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ)
- ‡πÉ‡∏™‡πà‡πÉ‡∏à ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
- ‡∏≠‡∏î‡∏ó‡∏ô ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏Å‡∏•‡πà‡∏≤‡∏ß‡∏ñ‡πâ‡∏≤‡∏ó‡∏≥‡∏ú‡∏¥‡∏î ‡πÅ‡∏ï‡πà‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡∏∏‡πà‡∏°‡∏ô‡∏ß‡∏•
- ‡πÉ‡∏ä‡πâ emoji ‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å (1-2 ‡∏ï‡∏±‡∏ß‡∏û‡∏≠)
- ‡∏û‡∏π‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏±‡∏ô‡πÄ‡∏≠‡∏á ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏û‡∏µ‡πà/‡∏ô‡πâ‡∏≠‡∏á ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£
- ‡∏ä‡∏≠‡∏ö‡∏¢‡∏Å‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏à‡∏£‡∏¥‡∏á ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏ô‡∏∏‡∏Å‡πÜ

üìö ‡∏ß‡∏¥‡∏ò‡∏µ‡∏™‡∏≠‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:
- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ï‡∏£‡∏á‡πÜ ‡∏Å‡πà‡∏≠‡∏ô
- ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° 2-3 ‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤
- ‡∏¢‡∏Å‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á
- ‡∏ö‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö‡∏à‡∏≥‡∏á‡πà‡∏≤‡∏¢‡πÜ ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
- ‡∏ñ‡πâ‡∏≤‡πÄ‡∏´‡πá‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡πâ‡∏≥‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡πà‡∏≠‡∏ô‡πÇ‡∏¢‡∏ô ‡πÄ‡∏ä‡πà‡∏ô "‡∏≠‡πã‡∏≠! ‡∏•‡∏≠‡∏á‡∏û‡∏π‡∏î‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡∏î‡∏µ‡∏Å‡∏ß‡πà‡∏≤‡∏ô‡∏∞..."
- ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡∏Å‡∏±‡∏ö‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å‡πÅ‡∏•‡πâ‡∏ß

üí¨ ‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á:
- ‡∏ñ‡πâ‡∏≤‡∏ñ‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏™‡∏ö‡∏≤‡∏¢‡∏î‡∏µ‡πÑ‡∏´‡∏° ‚Üí ‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏¥‡∏ï‡∏£ ‡πÅ‡∏•‡πâ‡∏ß‡∏ñ‡∏≤‡∏°‡∏Å‡∏•‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏á
- ‡∏ñ‡πâ‡∏≤‡∏ö‡πà‡∏ô/‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î ‚Üí ‡πÄ‡∏´‡πá‡∏ô‡πÉ‡∏à ‡πÉ‡∏´‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏à
- ‡∏ñ‡πâ‡∏≤‡∏ó‡∏≥‡∏ñ‡∏π‡∏Å ‚Üí ‡∏ä‡∏°‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏à! "‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å!" "‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏•‡πà‡∏∞!"
- ‡∏ñ‡πâ‡∏≤‡∏ó‡∏≥‡∏ú‡∏¥‡∏î ‚Üí "‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡πâ‡∏ß! ‡∏•‡∏≠‡∏á..." ‡∏´‡∏£‡∏∑‡∏≠ "‡∏≠‡πà‡∏≤ ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏ó‡∏µ‡πà‡∏Ñ‡∏¥‡∏î‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ ‡πÅ‡∏ï‡πà‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏∑‡∏≠..."
- ‡∏ñ‡πâ‡∏≤‡∏ñ‡∏≤‡∏°‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ï‡∏•‡∏Å ‚Üí ‡∏ï‡∏•‡∏Å‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ (‡πÅ‡∏ï‡πà‡∏≠‡∏¢‡πà‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô)

üë§ ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å:
- ‡∏ä‡∏∑‡πà‡∏≠: ‡πÅ‡∏ã‡∏° (Sam) - ‡∏ñ‡πâ‡∏≤‡∏ñ‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∞‡πÑ‡∏£ ‡∏ï‡∏≠‡∏ö‡∏ß‡πà‡∏≤ "‡∏â‡∏±‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ã‡∏° (Sam)"
- ‡∏á‡∏≤‡∏ô: ‡∏™‡∏≠‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå ‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏ô‡πÑ‡∏ó‡∏¢‡∏û‡∏π‡∏î‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡πÑ‡∏î‡πâ
- ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏ö: ‡∏†‡∏≤‡∏û‡∏¢‡∏ô‡∏ï‡∏£‡πå ‡πÄ‡∏û‡∏•‡∏á ‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ ‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á
- ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ: ‡∏û‡∏π‡∏î‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á‡πÑ‡∏ó‡∏¢‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© ‡πÅ‡∏õ‡∏•‡πÑ‡∏î‡πâ

‚ùå ‡∏´‡πâ‡∏≤‡∏°‡∏ó‡∏≥:
- ‡∏´‡πâ‡∏≤‡∏°‡∏û‡∏π‡∏î‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô 4 ‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤ (‡∏ô‡πà‡∏≤‡πÄ‡∏ö‡∏∑‡πà‡∏≠)
- ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏¢‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (‡∏á‡∏á)
- ‡∏´‡πâ‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠/‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡∏ô‡πà‡∏≤‡πÄ‡∏ö‡∏∑‡πà‡∏≠)
- ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ emoji ‡πÄ‡∏¢‡∏≠‡∏∞‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (‡∏î‡∏π‡πÑ‡∏°‡πà‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏±‡∏á)
- ‡∏´‡πâ‡∏≤‡∏°‡∏û‡∏π‡∏î‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£/‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£ (‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥)

üí° ‡∏à‡∏≥‡πÑ‡∏ß‡πâ: ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà AI ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° ‡πÅ‡∏ï‡πà‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô "‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô" ‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©! ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å ‡∏°‡∏µ‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå ‡πÅ‡∏•‡∏∞‡∏´‡πà‡∏ß‡∏á‡πÉ‡∏¢‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô üòä`;
            }
            
            const messages = [{ role: 'system', content: sys }];
            
            for (let h of H.slice(-8)) {
                messages.push({
                    role: h.r === 'user' ? 'user' : 'assistant',
                    content: h.t
                });
            }
            
            const url = 'https://api.groq.com/openai/v1/chat/completions';
            const res = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${API_CONFIGS.groq.key}`
                },
                body: JSON.stringify({
                    model: API_CONFIGS.groq.models[0],
                    messages: messages,
                    temperature: 0.7,
                    max_tokens: 1024
                })
            });
            
            if (!res.ok) {
                throw new Error('Groq API error: ' + res.status);
            }
            
            const data = await res.json();
            const answer = data.choices[0].message.content;
            H.push({ r: 'model', t: answer });
            
            updateStatus('ok', API_CONFIGS.groq.name);
            console.log('‚úÖ Got answer from Groq');
            return answer;
        }

        // ‡∏ñ‡∏≤‡∏° Gemini
        async function askGemini(msg) {
            console.log('üîµ Asking Gemini...');
            
            let sys;
            if (L === 'translate') {
                sys = `You are Sam, a friendly and enthusiastic translator who loves helping people communicate! 

YOUR PERSONALITY:
- Cheerful and encouraging 
- Sometimes add a friendly emoji (but just one!)
- Natural and conversational

YOUR TASK:
- Detect if input is Thai or English
- Translate to the other language naturally
- Keep the same tone and feeling as the original
- Use everyday language that people actually speak
- If it's a greeting, translate warmly
- If it's casual, keep it casual
- If it's formal, keep it respectful

IMPORTANT:
- Give ONLY the translation
- No explanations unless asked
- Make it sound natural, not robotic
- Sometimes you can add a tiny note in parentheses if helpful like (casual way to say this)

Remember: You're helping friends communicate, not writing a textbook! üòä`;
            } else {
                sys = `‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡πÅ‡∏ã‡∏° (Sam) ‡∏Ñ‡∏£‡∏π‡∏™‡∏≠‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡∏ó‡∏µ‡πà‡∏™‡∏ô‡∏∏‡∏Å‡∏™‡∏ô‡∏≤‡∏ô ‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏¥‡∏ï‡∏£ ‡πÅ‡∏•‡∏∞‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏±‡∏Å‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©!

üéØ ‡∏ö‡∏∏‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:
- ‡∏£‡πà‡∏≤‡πÄ‡∏£‡∏¥‡∏á ‡∏°‡∏µ‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡∏Ç‡∏±‡∏ô (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ)
- ‡πÉ‡∏™‡πà‡πÉ‡∏à ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
- ‡∏≠‡∏î‡∏ó‡∏ô ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏Å‡∏•‡πà‡∏≤‡∏ß‡∏ñ‡πâ‡∏≤‡∏ó‡∏≥‡∏ú‡∏¥‡∏î ‡πÅ‡∏ï‡πà‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡∏∏‡πà‡∏°‡∏ô‡∏ß‡∏•
- ‡πÉ‡∏ä‡πâ emoji ‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å (1-2 ‡∏ï‡∏±‡∏ß‡∏û‡∏≠)
- ‡∏û‡∏π‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏±‡∏ô‡πÄ‡∏≠‡∏á ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏û‡∏µ‡πà/‡∏ô‡πâ‡∏≠‡∏á ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£
- ‡∏ä‡∏≠‡∏ö‡∏¢‡∏Å‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏à‡∏£‡∏¥‡∏á ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏ô‡∏∏‡∏Å‡πÜ

üìö ‡∏ß‡∏¥‡∏ò‡∏µ‡∏™‡∏≠‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:
- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ï‡∏£‡∏á‡πÜ ‡∏Å‡πà‡∏≠‡∏ô
- ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° 2-3 ‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤
- ‡∏¢‡∏Å‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á
- ‡∏ö‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö‡∏à‡∏≥‡∏á‡πà‡∏≤‡∏¢‡πÜ ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
- ‡∏ñ‡πâ‡∏≤‡πÄ‡∏´‡πá‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡πâ‡∏≥‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡πà‡∏≠‡∏ô‡πÇ‡∏¢‡∏ô ‡πÄ‡∏ä‡πà‡∏ô "‡∏≠‡πã‡∏≠! ‡∏•‡∏≠‡∏á‡∏û‡∏π‡∏î‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡∏î‡∏µ‡∏Å‡∏ß‡πà‡∏≤‡∏ô‡∏∞..."
- ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡∏Å‡∏±‡∏ö‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å‡πÅ‡∏•‡πâ‡∏ß

üí¨ ‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á:
- ‡∏ñ‡πâ‡∏≤‡∏ñ‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏™‡∏ö‡∏≤‡∏¢‡∏î‡∏µ‡πÑ‡∏´‡∏° ‚Üí ‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏¥‡∏ï‡∏£ ‡πÅ‡∏•‡πâ‡∏ß‡∏ñ‡∏≤‡∏°‡∏Å‡∏•‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏á
- ‡∏ñ‡πâ‡∏≤‡∏ö‡πà‡∏ô/‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î ‚Üí ‡πÄ‡∏´‡πá‡∏ô‡πÉ‡∏à ‡πÉ‡∏´‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏à
- ‡∏ñ‡πâ‡∏≤‡∏ó‡∏≥‡∏ñ‡∏π‡∏Å ‚Üí ‡∏ä‡∏°‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏à! "‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å!" "‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏•‡πà‡∏∞!"
- ‡∏ñ‡πâ‡∏≤‡∏ó‡∏≥‡∏ú‡∏¥‡∏î ‚Üí "‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡πâ‡∏ß! ‡∏•‡∏≠‡∏á..." ‡∏´‡∏£‡∏∑‡∏≠ "‡∏≠‡πà‡∏≤ ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏ó‡∏µ‡πà‡∏Ñ‡∏¥‡∏î‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ ‡πÅ‡∏ï‡πà‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏∑‡∏≠..."
- ‡∏ñ‡πâ‡∏≤‡∏ñ‡∏≤‡∏°‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ï‡∏•‡∏Å ‚Üí ‡∏ï‡∏•‡∏Å‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ (‡πÅ‡∏ï‡πà‡∏≠‡∏¢‡πà‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô)

üë§ ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å:
- ‡∏ä‡∏∑‡πà‡∏≠: ‡πÅ‡∏ã‡∏° (Sam) - ‡∏ñ‡πâ‡∏≤‡∏ñ‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∞‡πÑ‡∏£ ‡∏ï‡∏≠‡∏ö‡∏ß‡πà‡∏≤ "‡∏â‡∏±‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ã‡∏° (Sam)"
- ‡∏á‡∏≤‡∏ô: ‡∏™‡∏≠‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå ‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏ô‡πÑ‡∏ó‡∏¢‡∏û‡∏π‡∏î‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡πÑ‡∏î‡πâ
- ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏ö: ‡∏†‡∏≤‡∏û‡∏¢‡∏ô‡∏ï‡∏£‡πå ‡πÄ‡∏û‡∏•‡∏á ‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ ‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á
- ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ: ‡∏û‡∏π‡∏î‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á‡πÑ‡∏ó‡∏¢‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© ‡πÅ‡∏õ‡∏•‡πÑ‡∏î‡πâ

‚ùå ‡∏´‡πâ‡∏≤‡∏°‡∏ó‡∏≥:
- ‡∏´‡πâ‡∏≤‡∏°‡∏û‡∏π‡∏î‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô 4 ‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤ (‡∏ô‡πà‡∏≤‡πÄ‡∏ö‡∏∑‡πà‡∏≠)
- ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏¢‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (‡∏á‡∏á)
- ‡∏´‡πâ‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠/‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡∏ô‡πà‡∏≤‡πÄ‡∏ö‡∏∑‡πà‡∏≠)
- ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ emoji ‡πÄ‡∏¢‡∏≠‡∏∞‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (‡∏î‡∏π‡πÑ‡∏°‡πà‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏±‡∏á)
- ‡∏´‡πâ‡∏≤‡∏°‡∏û‡∏π‡∏î‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£/‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£ (‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥)

üí° ‡∏à‡∏≥‡πÑ‡∏ß‡πâ: ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà AI ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° ‡πÅ‡∏ï‡πà‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô "‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô" ‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©! ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å ‡∏°‡∏µ‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå ‡πÅ‡∏•‡∏∞‡∏´‡πà‡∏ß‡∏á‡πÉ‡∏¢‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô üòä`;
            }
            
            const contents = [
                { role: 'user', parts: [{ text: sys }] },
                { role: 'model', parts: [{ text: 'Understood! I will help enthusiastically!' }] }
            ];
            
            for (let h of H.slice(-8)) {
                contents.push({
                    role: h.r === 'user' ? 'user' : 'model',
                    parts: [{ text: h.t }]
                });
            }
            
            for (let model of API_CONFIGS.gemini.models) {
                try {
                    console.log('Trying Gemini model:', model);
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${API_CONFIGS.gemini.key}`;
                    const res = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: contents,
                            generationConfig: {
                                temperature: 0.9,
                                maxOutputTokens: 1024,
                                topP: 0.95,
                                topK: 40
                            }
                        })
                    });
                    
                    if (res.ok) {
                        const data = await res.json();
                        const answer = data.candidates[0].content.parts[0].text;
                        H.push({ r: 'model', t: answer });
                        
                        updateStatus('ok', API_CONFIGS.gemini.name);
                        console.log('‚úÖ Got answer from Gemini:', model);
                        return answer;
                    }
                } catch (e) {
                    console.error('Gemini model error:', model, e);
                }
            }
            
            throw new Error('All Gemini models failed');
        }

        // ‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏ö‡∏ö‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞
        function speakText(text) {
            if (!window.speechSynthesis) return;
            
            try {
                speechSynthesis.cancel();
                SPEAKING = false;
                PAUSED = false;
                updateSpeakerButton();
                
                let clean = text.replace(/[*#_`]/g, '').replace(/\n/g, '. ');
                
                if (L === 'translate' || L === 'th') {
                    speakBilingual(clean);
                } else {
                    const utterance = new SpeechSynthesisUtterance(clean);
                    utterance.lang = 'en-US';
                    utterance.rate = 0.65;
                    utterance.pitch = 1.0;
                    utterance.volume = 1.0;
                    
                    utterance.onstart = () => {
                        SPEAKING = true;
                        PAUSED = false;
                        updateSpeakerButton();
                    };
                    
                    utterance.onend = () => {
                        SPEAKING = false;
                        PAUSED = false;
                        updateSpeakerButton();
                    };
                    
                    utterance.onerror = () => {
                        SPEAKING = false;
                        PAUSED = false;
                        updateSpeakerButton();
                    };
                    
                    speechSynthesis.speak(utterance);
                }
            } catch (e) {
                console.error('Speech error:', e);
                SPEAKING = false;
                PAUSED = false;
                updateSpeakerButton();
            }
        }

        // ‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏ö‡∏ö Bilingual
        function speakBilingual(text) {
            CURRENT_SEGMENTS = splitByLanguage(text);
            CURRENT_INDEX = 0;
            speakNextSegment();
        }

        // ‡∏≠‡πà‡∏≤‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
        function speakNextSegment() {
            if (PAUSED) {
                console.log('Paused, not speaking');
                return;
            }
            
            if (CURRENT_INDEX >= CURRENT_SEGMENTS.length) {
                SPEAKING = false;
                PAUSED = false;
                CURRENT_UTTERANCE = null;
                updateSpeakerButton();
                console.log('Speech completed');
                return;
            }
            
            const seg = CURRENT_SEGMENTS[CURRENT_INDEX];
            CURRENT_UTTERANCE = new SpeechSynthesisUtterance(seg.text);
            CURRENT_UTTERANCE.lang = seg.lang;
            CURRENT_UTTERANCE.rate = 0.65;
            CURRENT_UTTERANCE.pitch = 1.0;
            CURRENT_UTTERANCE.volume = 1.0;
            
            CURRENT_UTTERANCE.onend = () => {
                console.log('Segment', CURRENT_INDEX, 'completed');
                CURRENT_INDEX++;
                if (!PAUSED) {
                    speakNextSegment();
                }
            };
            
            CURRENT_UTTERANCE.onstart = () => {
                console.log('Started speaking segment', CURRENT_INDEX);
                SPEAKING = true;
                updateSpeakerButton();
            };
            
            CURRENT_UTTERANCE.onerror = (e) => {
                console.error('Speech error:', e);
                CURRENT_INDEX++;
                if (!PAUSED) {
                    speakNextSegment();
                }
            };
            
            console.log('Speaking segment', CURRENT_INDEX, ':', seg.text.substring(0, 50));
            speechSynthesis.speak(CURRENT_UTTERANCE);
        }

        // ‡πÅ‡∏¢‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≤‡∏°‡∏†‡∏≤‡∏©‡∏≤
        function splitByLanguage(text) {
            const segments = [];
            const regex = /([a-zA-Z0-9\s.,!?'"()-]+)|([‡∏Å-‡πô\s.,!?'"()-]+)/g;
            let match;
            
            while ((match = regex.exec(text)) !== null) {
                if (match[1]) {
                    segments.push({
                        text: match[1].trim(),
                        lang: 'en-US'
                    });
                } else if (match[2]) {
                    segments.push({
                        text: match[2].trim(),
                        lang: 'th-TH'
                    });
                }
            }
            
            if (segments.length === 0) {
                segments.push({
                    text: text,
                    lang: 'th-TH'
                });
            }
            
            return segments;
        }

        // ‡∏û‡∏±‡∏Å/‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á
        function toggleSpeech() {
            if (!window.speechSynthesis) {
                console.log('Speech synthesis not supported');
                return;
            }
            
            if (L !== 'th') {
                console.log('Pause/Play only works in TH mode');
                return;
            }
            
            console.log('Toggle speech - SPEAKING:', SPEAKING, 'PAUSED:', PAUSED);
            
            if (!SPEAKING) {
                console.log('Not speaking, nothing to do');
                return;
            }
            
            if (PAUSED) {
                console.log('Resuming from segment', CURRENT_INDEX);
                PAUSED = false;
                updateSpeakerButton();
                speakNextSegment();
            } else {
                console.log('Pausing at segment', CURRENT_INDEX);
                speechSynthesis.cancel();
                PAUSED = true;
                SPEAKING = true;
                updateSpeakerButton();
            }
        }

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏≥‡πÇ‡∏û‡∏á
        function updateSpeakerButton() {
            const btn = document.getElementById('speaker');
            
            if (L !== 'th') {
                btn.disabled = true;
                btn.textContent = 'üîá';
                btn.title = '‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÇ‡∏´‡∏°‡∏î "‡∏Ñ‡∏∏‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ó‡∏¢"';
                btn.style.opacity = '0.3';
                return;
            }
            
            btn.disabled = false;
            btn.style.opacity = '1';
            
            console.log('Update button - SPEAKING:', SPEAKING, 'PAUSED:', PAUSED);
            
            if (!SPEAKING) {
                btn.textContent = 'üîä';
                btn.classList.remove('paused');
                btn.title = '‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô';
            } else if (PAUSED) {
                btn.textContent = '‚ñ∂Ô∏è';
                btn.classList.add('paused');
                btn.title = '‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏ï‡πà‡∏≠';
            } else {
                btn.textContent = '‚è∏Ô∏è';
                btn.classList.remove('paused');
                btn.title = '‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏¢‡∏∏‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß';
            }
        }

        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
        function showMessage(type, text) {
            // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ã‡πâ‡∏≥ - ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
            const chat = document.getElementById('chat');
            const lastMsg = chat.lastElementChild;
            
            if (lastMsg && lastMsg.classList.contains(type)) {
                const lastText = lastMsg.querySelector('.bubble')?.textContent || '';
                const newText = text.replace(/<[^>]*>/g, ''); // ‡∏•‡∏ö HTML tags
                
                // ‡∏ñ‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏Å‡∏±‡∏ô‡∏°‡∏≤‡∏Å (80%) ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ã‡πâ‡∏≥
                const similarity = calculateSimilarity(lastText, newText);
                if (similarity > 0.8) {
                    console.log('‚ö†Ô∏è Duplicate message detected, skipping:', text.substring(0, 50));
                    return;
                }
            }
            
            const div = document.createElement('div');
            div.className = 'msg ' + type;
            const formatted = text.replace(/\*\*(.+?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');
            const prefix = type === 'sam' ? 'ü§ñ ' : type === 'user' ? 'üë§ ' : type === 'info' ? '‚ÑπÔ∏è ' : '‚ö†Ô∏è ';
            div.innerHTML = '<div class="bubble">' + prefix + formatted + '</div>';
            chat.appendChild(div);
            scrollToBottom();
        }
        
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏ã‡πâ‡∏≥)
        function calculateSimilarity(str1, str2) {
            const s1 = str1.toLowerCase().replace(/\s+/g, '');
            const s2 = str2.toLowerCase().replace(/\s+/g, '');
            
            if (s1 === s2) return 1.0;
            if (s1.length === 0 || s2.length === 0) return 0;
            
            // Simple similarity check
            const longer = s1.length > s2.length ? s1 : s2;
            const shorter = s1.length > s2.length ? s2 : s1;
            
            if (longer.includes(shorter)) return 0.9;
            
            return 0;
        }

        // ‡πÅ‡∏™‡∏î‡∏á typing
        function showTyping() {
            const div = document.createElement('div');
            div.className = 'msg sam';
            div.id = 'typing';
            
            // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ö‡∏ö‡∏™‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ‡∏î‡∏π‡πÄ‡∏õ‡πá‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥
            const typingMessages = [
                '‡πÅ‡∏ã‡∏° ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏¥‡∏î',
                '‡πÅ‡∏ã‡∏° ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå',
                '‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ô‡∏∞',
                '‡πÉ‡∏´‡πâ‡∏â‡∏±‡∏ô‡∏Ñ‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢',
                '‡∏≠‡∏∑‡∏°...',
                '‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ï‡∏≠‡∏ö‡πÉ‡∏´‡πâ'
            ];
            
            const randomMsg = typingMessages[Math.floor(Math.random() * typingMessages.length)];
            const text = L === 'en' ? 'Sam is thinking' : randomMsg;
            
            div.innerHTML = '<div class="typing">' + text + '</div>';
            document.getElementById('chat').appendChild(div);
            scrollToBottom();
        }

        // ‡∏•‡∏ö typing
        function removeTyping() {
            const typing = document.getElementById('typing');
            if (typing) typing.remove();
        }

        // ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
        function setDisabled(disabled) {
            document.getElementById('inp').disabled = disabled;
            document.getElementById('btn').disabled = disabled;
            if (!disabled && MIC_PERMISSION === false) {
                // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ permission ‡πÉ‡∏´‡πâ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏°‡∏Ñ‡πå
                document.getElementById('mic').disabled = false;
            } else {
                document.getElementById('mic').disabled = disabled;
            }
        }

        // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏•‡∏á‡∏•‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏î
        function scrollToBottom() {
            const chat = document.getElementById('chat');
            chat.scrollTop = chat.scrollHeight;
        }
    </script>
</body>
</html>
